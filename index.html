<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£. Ø£ÙŠÙ…Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .container {
            max-width: 90rem; /* Increased max width */
        }
        .header-gradient {
            background-image: linear-gradient(to right, #4c51bf, #6b46c1);
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <header class="header-gradient text-white p-6 rounded-xl shadow-2xl mb-10 container mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ </h1>
        <p class="text-lg mt-2 opacity-90">Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø±ÙŠØ¨ - Ø£Ø³ØªØ§Ø° Ø£ÙŠÙ…Ù†</p>
    </header>

    <main class="container mx-auto">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-xl font-bold mb-5 text-gray-800">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                
                <div class="col-span-full md:col-span-1">
                    <label for="classFilter" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                    <select id="classFilter" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        <option value="s1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="s2">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="s3">ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                    </select>
                </div>

                <div class="col-span-full md:col-span-1">
                    <label for="nameSearch" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="nameSearch" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒØ§Ù…Ù„Ø§Ù‹" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                </div>

                <div class="col-span-full md:col-span-1">
                    <label for="phoneSearch" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" id="phoneSearch" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="w-full bg-gray-100 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                
                <div class="col-span-full md:col-span-1 flex items-end">
                    <button id="applyFilterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md">
                        ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (<span id="resultsCount">0</span> Ù†ØªÙŠØ¬Ø©)</h2>
            <div class="table-container overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">#</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ù„Ø§Ø³Ù…</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ù„ØµÙ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Ø£Ø®Ø·Ø§Ø¡ (ID)</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500" id="loadingRow">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // *************************************************************
        // ** âš ï¸ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Supabase âš ï¸ **
        // *************************************************************
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTU1NDEsImV4cCI6MjA3ODI3MTU0MX0.G-MsJtbQ1LlPZO-Vob6nKzdClHmOYu6RFOKi62FKKNk";
        const TABLE_NAME = "quiz_results";
        // *************************************************************

        const resultsTableBody = document.getElementById('resultsTableBody');
        const resultsCountSpan = document.getElementById('resultsCount');
        const classFilter = document.getElementById('classFilter');
        const nameSearch = document.getElementById('nameSearch');
        const phoneSearch = document.getElementById('phoneSearch');
        const applyFilterBtn = document.getElementById('applyFilterBtn');

        // Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
        const classNamesMap = {
            's1': 'Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ',
            's2': 'ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ',
            's3': 'ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ'
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        async function fetchResults() {
            resultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ...</td></tr>';
            resultsCountSpan.textContent = '0';
            
            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (Query)
            let url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*&order=submission_time.desc`;
            
            const selectedClass = classFilter.value;
            const searchName = nameSearch.value.trim();
            const searchPhone = phoneSearch.value.trim();

            // 1. ÙÙ„ØªØ±Ø© Ø§Ù„ØµÙ
            if (selectedClass !== 'all') {
                const className = classNamesMap[selectedClass];
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… `eq` Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
                url += `&class_name=eq.${className}`; 
            }
            
            // 2. Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…
            if (searchName) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… `ilike` Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙˆØºÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù
                url += `&student_name=ilike.*${searchName}*`;
            }

            // 3. Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            if (searchPhone) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… `ilike` Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø±Ù‚Ù…
                url += `&student_phone=ilike.*${searchPhone}*`;
            }

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        // Ù‡Ù†Ø§ Ù†Ø·Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙƒÙ„ÙŠ ÙÙŠ Ø§Ù„Ø±Ø£Ø³
                        'Prefer': 'count=exact' 
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                const totalCount = response.headers.get('content-range').split('/')[1];
                const data = await response.json();
                
                displayResults(data);
                resultsCountSpan.textContent = totalCount;

            } catch (error) {
                console.error('Error fetching data from Supabase:', error);
                resultsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500 font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (SELECT Policy).</td></tr>`;
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function displayResults(results) {
            resultsTableBody.innerHTML = '';
            if (results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¨Ø­Ø«.</td></tr>';
                return;
            }

            results.forEach((result, index) => {
                const percentage = ((result.score / result.total_questions) * 100).toFixed(0);
                
                // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡
                let scoreColor = 'text-red-600';
                if (percentage >= 80) {
                    scoreColor = 'text-green-600 font-extrabold';
                } else if (percentage >= 50) {
                    scoreColor = 'text-yellow-600 font-bold';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${result.student_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${result.student_phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600">${result.class_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-lg ${scoreColor}">${result.score} / ${result.total_questions} (${percentage}%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(result.submission_time).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })}</td>
                    <td class="px-6 py-4 text-sm text-red-400 max-w-xs overflow-hidden text-ellipsis">${result.wrong_questions_ids || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        }

        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„ÙÙ„ØªØ±
        applyFilterBtn.addEventListener('click', fetchResults);
        
        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        nameSearch.addEventListener('input', fetchResults);
        phoneSearch.addEventListener('input', fetchResults);
        
        // Ø±Ø¨Ø· Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ
        classFilter.addEventListener('change', fetchResults);

        // Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', fetchResults);
    </script>
</body>
</html>








